version: 2.1
jobs:
  build-and-push:
    docker:
      - image: circleci/docker:stable
    steps:
      - checkout
      - setup_remote_docker:
          version: default
          docker_auth:
            username: $DOCKER_USERNAME
            password: $DOCKER_PASSWORD
      - run:
          name: Build and push Docker images
          command: |
            docker-compose -f docker-compose-build.yaml build

            # Tag and push each image
            docker tag reverseproxy $DOCKER_USERNAME/reverseproxy:latest
            docker push $DOCKER_USERNAME/reverseproxy:latest

            docker tag udagram-api-user $DOCKER_USERNAME/udagram-api-user:latest
            docker push $DOCKER_USERNAME/udagram-api-user:latest

            docker tag udagram-api-feed $DOCKER_USERNAME/udagram-api-feed:latest
            docker push $DOCKER_USERNAME/udagram-api-feed:latest

            docker tag udagram-frontend:local $DOCKER_USERNAME/udagram-frontend:latest
            docker push $DOCKER_USERNAME/udagram-frontend:latest

workflows:
  version: 2
  build_and_push:
    jobs:
      - build-and-push:
          context: docker-hub-creds
